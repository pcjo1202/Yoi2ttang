# 📊 API 성능 모니터링 가이드

## ✨ 기준: React 19, Next.js 15, TanStack Query v5

---

## 🎯 측정 가능한 KPI

### 📞 호출 빈도 KPI

- **총 API 호출 횟수**: 측정 기간 동안 총 요청 수 (캐시 포함)
- **실제 API 호출**: 서버로 전송된 실제 네트워크 요청
- **캐시에서 응답**: 캐시로 처리된 요청 수
- **분당 호출 횟수**: 사용자 활동 강도 측정
- **중복 호출 횟수**: 1초 내 같은 URL로의 중복 요청 (최적화 필요 지표)

### ⏱️ 응답 시간 KPI

- **평균 응답 시간**: 모든 API 호출의 평균 응답 시간 (캐시 제외)
- **P95 응답 시간**: 상위 95% 사용자가 경험하는 응답 시간
- **P99 응답 시간**: 상위 99% 사용자가 경험하는 응답 시간

### 💾 캐싱 효율 KPI

- **캐시 적중률**: 캐시로 처리된 요청 비율 (목표: 70% 이상)
- **캐시 미스율**: 실제 API 호출이 필요했던 비율 (낮을수록 좋음)

### 🎯 사용자 경험 KPI

- **로딩 표시 횟수**: 사용자에게 로딩 UI가 보인 횟수 (적을수록 부드러운 UX)
- **평균 인터랙션 지연**: 사용자 액션 → 결과 표시까지 시간 (목표: <100ms)

---

## 🚀 사용 방법

### 1단계: 측정 시작

1. 타일 지도 페이지 (`/tile-map`)로 이동
2. 오른쪽 하단의 **▶️ 측정 시작** 버튼 클릭
3. 콘솔에 `🎬 API 모니터링 시작!` 메시지 표시

### 2단계: 지도 사용 및 실시간 모니터링

- 자유롭게 지도 이동, 줌 인/아웃
- 상단에 실시간 통계 표시:
  ```
  🔴 호출: 15회 | 캐시: 73.3%
  ```
- 콘솔에서 각 호출의 상세 정보 확인:
  ```
  📞 호출: 1회 (API: 1, 캐시: 0) | 🌐 API 234ms
  📞 호출: 2회 (API: 1, 캐시: 1) | ✅ Cache HIT 1ms
  ```

### 3단계: 결과 확인

**📊 결과 보기** 버튼 클릭 시 콘솔에 상세 리포트 표시:

```
============================================================
📊 API 성능 측정 결과
============================================================

📞 호출 빈도 KPI
────────────────────────────────────────────────────────────
   총 API 호출 횟수: 45회
   실제 API 호출: 12회
   캐시에서 응답: 33회
   분당 호출 횟수: 22.5회/분
   중복 호출 횟수: 2회

⏱️  응답 시간 KPI
────────────────────────────────────────────────────────────
   평균 응답 시간: 187ms
   P95 응답 시간: 320ms
   P99 응답 시간: 450ms

💾 캐싱 효율 KPI
────────────────────────────────────────────────────────────
   캐시 적중률: 73.3% ✅
   캐시 미스율: 26.7%

🎯 사용자 경험 KPI
────────────────────────────────────────────────────────────
   로딩 표시 횟수: 12회
   평균 인터랙션 지연: 95ms ✅

📊 측정 정보
────────────────────────────────────────────────────────────
   측정 시간: 120.3초

============================================================
```

### 4단계: 데이터 내보내기

**💾 내보내기** 버튼 클릭 시 JSON 파일 다운로드:

```json
{
  "timestamp": "2025-10-23T05:30:00.000Z",
  "summary": {
    "총 API 호출": 45,
    "실제 API 호출": 12,
    "캐시에서 응답": 33,
    "평균 응답시간": "187ms",
    "캐시 적중률": "73.3%",
    ...
  },
  "details": {
    "totalCalls": 45,
    "calls": [
      {
        "timestamp": 1234567890,
        "responseTime": 234,
        "cached": false,
        "url": "/tiles/teams/new"
      },
      ...
    ],
    "loadingCount": 12,
    "interactionDelays": [95, 102, 87, ...]
  }
}
```

### 5단계: 측정 초기화

**🔄 초기화** 버튼 클릭 시:

- 모든 측정 데이터 리셋
- 자동으로 새로운 측정 시작
- 이전 데이터와 비교 분석 가능

---

## 📊 성능 비교 프로세스

### Before (기존 방식) 측정

```bash
1. ▶️ 측정 시작 클릭
2. 5분간 지도 사용:
   - 서울 중심 → 강남 → 홍대 → 서울 중심 (재방문)
   - 줌 레벨: 14 → 16 → 18 → 16 → 14
   - 같은 위치 여러 번 방문
3. 📊 결과 보기 클릭
4. 💾 내보내기 클릭 → baseline.json 저장
5. 콘솔 스크린샷 저장 → baseline.png
```

### After (Geohash 캐싱) 측정

```bash
1. Geohash 캐싱 코드 적용
2. 🔄 초기화 클릭 (새로운 측정 시작)
3. 동일한 패턴으로 5분간 사용
4. 📊 결과 보기 클릭
5. 💾 내보내기 클릭 → optimized.json 저장
6. 콘솔 스크린샷 저장 → optimized.png
```

### 결과 비교표 작성

```markdown
| KPI           | 기존  | 개선 후 | 개선율 |
| ------------- | ----- | ------- | ------ |
| 총 API 호출   | 127회 | 45회    | ↓ 65%  |
| 실제 API 호출 | 127회 | 12회    | ↓ 91%  |
| 평균 응답     | 234ms | 95ms    | ↓ 59%  |
| 캐시 적중률   | 0%    | 73.3%   | ↑ 73%  |
| 로딩 표시     | 127회 | 12회    | ↓ 91%  |
```

---

## 🎯 목표 달성 체크리스트

### ✅ 성공 기준

- [ ] 총 API 호출 횟수 70% 이상 감소
- [ ] 캐시 적중률 70% 이상 달성
- [ ] 평균 응답 시간 50% 이상 감소
- [ ] P95 응답 시간 200ms 이하
- [ ] 평균 인터랙션 지연 100ms 이하
- [ ] 중복 호출 0건

### ⚠️ 주의 사항

1. **측정 환경 일관성 유지**

   - 동일한 브라우저 사용
   - 동일한 네트워크 환경
   - 유사한 사용 패턴

2. **충분한 측정 시간**

   - 최소 5분 이상 사용
   - 다양한 시나리오 포함
   - 재방문 패턴 포함

3. **개발 환경에서만 실행**
   - 프로덕션 환경에서는 자동으로 비활성화
   - 성능 오버헤드 최소화

---

## 🔧 기술 구현 세부사항

### 측정 항목별 구현 방식

1. **API 호출 횟수**: axios 인터셉터에서 자동 카운트
2. **응답 시간**: Performance API 활용 (performance.now())
3. **캐시 히트 감지**: TanStack Query의 queryClient.getQueryData() 활용
4. **중복 호출**: 시간 창(1초) 내 동일 URL 감지
5. **인터랙션 지연**: useQuery의 isFetching 상태 변화 추적
6. **P95/P99**: 응답 시간 배열 정렬 후 백분위수 계산

### 자동 측정 대상

- ✅ `/tiles/teams/new` - 전체 타일 조회
- ✅ `/tiles/teams/cluster` - 타일 클러스터 조회
- ✅ 기타 모든 API 호출

---

## 📈 예상 결과

### 기존 방식 (캐싱 없음)

```
총 API 호출: 127회
실제 API 호출: 127회 (100%)
평균 응답: 234ms
캐시 적중률: 0%
```

### 개선 후 (Geohash 캐싱)

```
총 API 호출: 45회
실제 API 호출: 12회 (27%)
평균 응답: 95ms
캐시 적중률: 73%
```

### 개선 효과

- ✅ **API 호출 91% 감소** (127회 → 12회)
- ✅ **응답 시간 59% 단축** (234ms → 95ms)
- ✅ **캐시 적중률 73% 달성**
- ✅ **사용자 경험 대폭 개선**

---

## 🐛 문제 해결

### Q: 실시간 통계가 업데이트되지 않아요

A: 페이지를 새로고침하고 측정을 다시 시작해보세요.

### Q: 캐시 적중률이 0%로 나와요

A: TanStack Query가 제대로 설정되었는지 확인하세요. queryKey가 올바르게 설정되어야 합니다.

### Q: JSON 파일이 다운로드되지 않아요

A: 브라우저의 다운로드 차단을 해제하거나, 콘솔에서 직접 데이터를 복사하세요.

---

## 📞 문의

성능 측정 관련 문의사항이 있으시면 개발팀에 연락주세요.

**Happy Performance Monitoring! 🚀**
